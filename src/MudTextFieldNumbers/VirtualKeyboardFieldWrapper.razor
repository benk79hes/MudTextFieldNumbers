@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.JSInterop
@inject VirtualKeyboardService? KeyboardService
@inject IJSRuntime JSRuntime
@implements IAsyncDisposable

@namespace MudTextFieldNumbers

<div @ref="_wrapperElement" data-vkb-wrapper="true">
    @ChildContent
</div>

@code {
    private ElementReference _wrapperElement;
    private DotNetObjectReference<VirtualKeyboardFieldWrapper>? _dotNetHelper;
    private bool _isInitialized = false;

    [Parameter]
    public RenderFragment? ChildContent { get; set; }

    [Parameter]
    public IVirtualKeyboardField? Field { get; set; }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && Field != null && KeyboardService != null)
        {
            try
            {
                // Small delay to ensure DOM is fully rendered
                await Task.Delay(50);
                
                _dotNetHelper = DotNetObjectReference.Create(this);
                
                await JSRuntime.InvokeVoidAsync("MudTextFieldNumbers.setupFocusHandlersForWrapper", 
                    _wrapperElement, _dotNetHelper);
                
                _isInitialized = true;
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error setting up focus handlers: {ex.Message}");
            }
        }
    }
    
    [JSInvokable]
    public void NotifyFocusIn()
    {
        if (KeyboardService != null && Field != null)
        {
            KeyboardService.SetActiveField(Field);
        }
    }
    
    [JSInvokable]
    public void NotifyFocusOut()
    {
        if (KeyboardService != null && Field != null && KeyboardService.ActiveField == Field)
        {
            KeyboardService.ClearActiveField();
        }
    }

    public async ValueTask DisposeAsync()
    {
        if (_isInitialized && _dotNetHelper != null)
        {
            try
            {
                await JSRuntime.InvokeVoidAsync("MudTextFieldNumbers.cleanupFocusHandlers", _wrapperElement);
            }
            catch
            {
                // Ignore errors during disposal
            }
            
            _dotNetHelper?.Dispose();
        }
    }
}
